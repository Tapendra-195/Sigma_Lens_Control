#include "Arduino.h"
#include "../include/Message03.h"

Message03::Message03(byte messageClass, byte sequenceNumber, byte messageType, const byte* body, uint16_t messageLength): Message(messageClass, sequenceNumber, messageType, body, messageLength) 
{
  mAperture = 0x1100;
}


void Message03::update()
{
  //increment sequence number
  mSequenceNumber++;
  
  byte aperture_L = mAperture & 0xFF;
  byte aperture_H = mAperture >> 8;

  //Target 1?
  mMessageBuffer[INDEX_APERTURE_L1] = aperture_L;
  mMessageBuffer[INDEX_APERTURE_H1] = aperture_H;

  //Target 2? (IDK what I am talking about, but they have same value)
  mMessageBuffer[INDEX_APERTURE_L2] = aperture_L;
  mMessageBuffer[INDEX_APERTURE_H2] = aperture_H;

  //Normal byte change from msg to msg
  //messageBuffer[8] = 0x08; 
  mMessageBuffer[28] = mMessageBuffer[28]^0x01; //Starts from 16 then changes between 16 and 17
  mMessageBuffer[16] = (mAperture >= 8.0f)?0x04:0x02;
  mMessageBuffer[18] = mMessageBuffer[18]^0x01;
  mMessageBuffer[17] = mMessageBuffer[INDEX_SEQUENCE_NUMBER]%mMessageBuffer[16];
}

void Message03::setAperture(unsigned int value)
{
  mAperture = value;
}
